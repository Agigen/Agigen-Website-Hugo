<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Buick Encore: high scalability behind the Great Firewall of China &middot; Agigen </title>

  
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/agigen.css">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Agigen" />

  <link rel="dns-prefetch" href="//ajax.googleapis.com">


  <script type="text/javascript" src="//use.typekit.net/orr5jqv.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>
<body ng-app="agigenApp" ng-controller="menuCtrl" class="page--buick-encore-high-scalability-behind-the-great-firewall-of-china">
<!-- 

                      `://.
                    `+AAAAAo.
                  `+AAAAAAAAAo.
                `+AAAAAAAAAAAAAo.
              `+AAAAAAAAAAAAAAAAAo.
            `+AAAAAAAAAAAAAAAAAAAAAo.
          `+AAAAAAAAAs/sAAAAAAAAAAAAAo.
        `+AAAAAAAAAA+`  -oAAAAAAAAAAAAAo.
      `+AAAAAAAAAAA+      .+AAAAAAAAAAAAAo.
    `+AAAAAAAAAAAA/         .+AAAAAAAAAAAAAo.
  `+AAAAAAAAAAAAA/            .+AAAAAAAAAAAAAo.
 +AAAAAAAAAAAAAA/               -sAAAAAAAAAAAAAo`
.AAAAAAAAAAAAAA+                 `+AAAAAAAAAAAAA/
 /AAAAAAAAAAAAs`       `-/+agigen:`:AAAAAAAAAAAo`
  `/AAAAAAAAAA.    .:+AAAAAAAAAAAAA+/AAAAAAAAo.
    `/AAAAAAAo.-/oAAAAAAAAAAAAAAAAAAAAAAAAAo.
      `/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAo.
        `/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAo.
          `/AAAAAAAAAAAAAAAAAAAAAAAAAo.
            `+AAAAAAAAAAAAAAAAAAAAAo.
              `+AAAAAAAAAAAAAAAAAo.
                `+AAAAAAAAAAAAAo.
                  `+AAAAAAAAAo.
                    `+AAAAAo.
                      `-::`
-->



<nav class="main-menu" ng-class="{'main-menu--expanded': menuVisible}" ng-click="hideMenu($event)">
    <section class="main-menu__grid">
        <ul class="nav nav--stacked">
            
            
                
                <li>
                    <a class="main-menu__link main-menu__link--main" href="/">Home</a>
                
                </li>
            
                
                <li class="sub-menu">
                    <span class="main-menu__section-name">Services</span>
                    <ul class="sub">
                    
                        <li>
                        <a href="/services/web-production" class="main-menu__link main-menu__link--sublink main-menu__link--webprod"> Web Production </a>
                        </li>
                    
                        <li>
                        <a href="/services/product-development" class="main-menu__link main-menu__link--sublink main-menu__link--proddev"> Product development </a>
                        </li>
                    
                        <li>
                        <a href="/services/labs" class="main-menu__link main-menu__link--sublink main-menu__link--labs"> Agigen Labs </a>
                        </li>
                    
                    </ul>
                
                </li>
            
                
                <li class="sub-menu">
                    <span class="main-menu__section-name">Learn more</span>
                    <ul class="sub">
                    
                        <li>
                        <a href="/work/" class="main-menu__link main-menu__link--sublink main-menu__link--cases"> Previous Work </a>
                        </li>
                    
                        <li>
                        <a href="/about/" class="main-menu__link main-menu__link--sublink main-menu__link--aboutus"> About us </a>
                        </li>
                    
                        <li>
                        <a href="/blog/" class="main-menu__link main-menu__link--sublink main-menu__link--blog"> Our diary </a>
                        </li>
                    
                    </ul>
                
                </li>
            
                
                <li class="sub-menu">
                    <span class="main-menu__section-name">Get in touch</span>
                    <ul class="sub">
                    
                        <li>
                        <a href="/contact/" class="main-menu__link main-menu__link--sublink main-menu__link--contactus"> Contact us </a>
                        </li>
                    
                    </ul>
                
                </li>
            
        </ul>
    </section>
</nav>

<div class="topbar" ng-class="{'menu-expanded': menuVisible}">
    <div class="container">
        <h1 class="topbar__title"><a href="/">

            <svg class="color-animation" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 244.8 190.6" enable-background="new 0 0 244.8 190.6" xml:space="preserve">
                <path  fill-rule="evenodd" clip-rule="evenodd" d="M92.1,3.8C105.7,15.2,219.5,105.1,240,185.9c-69.6-117.8-200.3,13.7-233.3,0
                    C-9.8,181.3,80.7-1.3,92.1,3.8z"/>
            </svg>

        </a></h1>

        <button class="topbar__menu-button" ng-click="menuVisible = !menuVisible"><i class="fa fa-align-justify"></i></button>
    </div>
</div>


<header class="main-header">
    <div class="main-header__content">
        <div class="container text--light">
            <h1 class="alpha">Buick Encore: high scalability behind the Great Firewall of China</h1>
            


        </div>
    </div>
    
</header>

<div class="main-content">


<div class="content">
    <article class="blog-post">
        <p><strong>Buick Encore is a mobile augmented reality game, created by us, <a href="http://monterosa.se">Monterosa</a> and <a href="http://www.ogilvy.com/">Ogilvy Shanghai</a>; we were responsible for the server-side backend part of the game, while Monterosa developed the iPhone and Android apps and Ogilvy was responsible for the game design and overall project management.</strong></p>

<p>The game idea revolves around a virtual car which is placed somewhere in a big Chinese city. Using their smartphone, the players can see an approximate location of this car, as well as the positions of other players, on a standard map. When they get close enough to the car, its exact location appears, they rotate their phone to portrait mode and an augmented reality view which shows the car blended into the real world appears. They can now &#8220;get in&#8221; the car and &#8220;drive it&#8221; for up to three minutes; at any time while they&#8217;re &#8220;driving&#8221; they can &#8220;get out&#8221; of the car and leave it at their current location. The purpose of the game is to find the car and then hide it; at the end of the gaming day, whoever managed to hide the car for the longest period of time wins.</p>

<p><a href="http://vimeo.com/49539651">Hide &amp; Seek presentation video</a> from <a href="http://vimeo.com/user8087696">saschaengel_china works</a> on <a href="http://vimeo.com">Vimeo</a>.</p>

<p>User login can be done either with <a href="http://www.weibo.com/">Sina Weibo</a> (a Chinese social media platform) or just a regular email address, and the backend can send push notifications to users using <a href="http://urbanairship.com/">Urban Airship&#8217;s</a> excellent service.</p>

<p>On the server side, we had to keep track of a rather large amount of real-time data, since both the car&#8217;s position and the position of each individual player are updated quite frequently and retained for a relatively long period of time. Each datapoint is rather small, but there are a lot of them per player and they accumulate quickly. Normally, this kind of application with frequent updates and frequent requests for updates from the clients would be very well suited to hosting on Google App Engine. In this case, however, we chose to not use App Engine, primarily because Google does not have a data center in China, and latencies to anything outside the Great Firewall are terrible. The customer was also worried about the potential for getting the application suddenly blocked. Hence, we rolled our own solution.</p>

<p>After some experiments with various technologies (such as REDIS, twisted.web and gevent), our server side backend ended up being written in Python, using:</p>

<ul>
<li>Tornado&#8217;s ioloop</li>
<li>MongoDB, using the asyncmongo Python API</li>
<li>memcache</li>
<li>nginx as a frontend</li>
<li>Stingray for load balancing</li>
<li>Twitter Bootstrap for the admin interface</li>
</ul>

<p>Since the customer was extremely worried about latency and scalability, we did quite extensive performance tests at an early stage to get a general idea of how much raw performance we could possibly squeeze out of a single server. Based on this we ended up ditching many of Tornado&#8217;s conveniences and wrote our own simplistic request handling framework. For interacting with MongoDB, we chose the asyncmongo module in order to avoid blocking our Tornado threads on I/O.</p>

<p>The entire application is hosted on a set of virtual machines at <a href="http://www.datapipe.com/">Datapipe&#8217;s</a> Shanghai datacenter. We evaluated several hosting solutions before choosing Datapipe; the customer requirement that all machines must be hosted inside mainland China disqualified many options, and in the end Datapipe&#8217;s convenient cloud solution and English-speaking customer service won out.</p>

<p>Since this technology stack (referred to by a certain hosting salesperson we spoke to as &#8220;the hipster stack&#8221;) was mostly unfamiliar to us before this project, we had a lot of interesting lessons to learn, the most important one being that creating web application backends using a completely callback-driven framework is sort of a pain and requires some careful design and planning in order to avoid a massive mess of spaghetti function calls. Most of us haven&#8217;t done much serious functional programming since the university courses in it, so this provided a handy refresher course involving things like partials, closures and other such fun.</p>

<div id="attachment_81" class="wp-caption aligncenter" style="width: 970px">
  <a href="http://blog.agigen.se/wp-content/uploads/2012/11/buick1.jpg"><img class="size-full wp-image-81" title="Buick Encore admin interface" alt="" src="http://blog.agigen.se/wp-content/uploads/2012/11/buick1.jpg" width="960" height="360" /></a><p class="wp-caption-text">
    The Buick Encore admin interface
  </p>
</div>

<p>Working with MongoDB in particular has been an interesting experience. It&#8217;s certainly very fast and ended up working quite well for our purposes, but we don&#8217;t think we&#8217;d choose it again for the next project, since it&#8217;s simply too tedious to work with. It&#8217;s certainly not all bad, but there are a number of small grating issues that makes it feel very rough to handle, at least to someone used to the NDB API of Google&#8217;s High Replication Datastore. A lot of this is related to the API we used to interact with the database: I feel a callback-driven async model is much harder to work with than the futures-based model the NDB API uses, but this also has to do with the fact that on App Engine it&#8217;s not a problem to block a thread for a few hundred milliseconds since other threads can use the same instance while you&#8217;re waiting. However, MongoDB itself also has quite a few minor irritations, particularly related to the generally hairy query syntax.</p>

<p>Tornado on the other hand has generally been pretty smooth to work with. It&#8217;s quite easy to roll your own request handling stuff based on its powerful ioloop functionality, but even if you don&#8217;t want to do that, the request handlers it ships with are well designed and polished. Our old friends nginx and memcache are nothing new, of course; there&#8217;s a reason we keep using them everywhere.</p>

<p>More about the project:
<a href="http://monterosa.se/work/buick-hide-and-seek/">Monterosa&#8217;s case page</a>
<a href="http://www.mynewsdesk.com/sg/pressroom/monterosa/pressrelease/view/buick-plays-hide-seek-in-china-800454">Monterosa press release</a></p>

    </article>
</div>

</div>
<footer class="main-footer">
    <div class="container">
        <h1 class="main-footer__title"><a href="/" title="Agigen">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 244.8 190.6" enable-background="new 0 0 244.8 190.6" xml:space="preserve">
                <path  fill-rule="evenodd" clip-rule="evenodd" d="M92.1,3.8C105.7,15.2,219.5,105.1,240,185.9c-69.6-117.8-200.3,13.7-233.3,0
                    C-9.8,181.3,80.7-1.3,92.1,3.8z"/>
            </svg>
        </a></h1>

    <nav class="main-footer__links">
        <a href="https://www.facebook.com/agigen" target="_blank" class="main-footer__link">Facebook</a>
        <a href="https://www.linkedin.com/company/640656" target="_blank" class="main-footer__link">LinkedIn</a>
        <a href="/contact" class="main-footer__link main-footer__link--bordered">Contact us</a>
    </nav>
</footer>


    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/js/jquery-2.1.1.min.js"><\/script>')</script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.22/angular.min.js"></script>
    <script src="/js/agigen.jquery-in-view.js"></script>
    <script src="/js/agigen.js"></script>
    <script>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

